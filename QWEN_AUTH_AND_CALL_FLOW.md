# QWen API 鉴权与调用流程图

## 1. 完整的端到端调用流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                    QWen API 完整调用流程                             │
└─────────────────────────────────────────────────────────────────────┘

┌──────────────────────┐
│   1. 初始化阶段      │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────────────────────┐
│ 获取API Key                          │
│ ├─ 访问dashscope.aliyun.com         │
│ ├─ 登录阿里云账户                    │
│ ├─ 创建API Key                       │
│ └─ 存储到环境变量或.env文件          │
└──────────┬───────────────────────────┘
           │
           ▼
┌──────────────────────────────────────┐
│ 2. 初始化客户端                      │
│ ├─ from openai import OpenAI         │
│ ├─ 设置API Key                       │
│ ├─ 设置Base URL                      │
│ └─ 配置其他参数（超时等）            │
└──────────┬───────────────────────────┘
           │
           ▼
┌──────────────────────────────────────┐
│ 3. 准备请求                          │
│ ├─ 构建messages列表                  │
│ ├─ 选择模型（qwen-plus等）           │
│ ├─ 设置参数（temperature等）         │
│ └─ 可选：添加tools定义                │
└──────────┬───────────────────────────┘
           │
           ▼
┌──────────────────────────────────────┐
│ 4. 发送请求 + 鉴权                   │
│ ├─ 将请求发送到服务器               │
│ ├─ 自动添加Authorization头          │
│ └─ 包含API Key                       │
└──────────┬───────────────────────────┘
           │
           ▼
┌──────────────────────────────────────┐
│ 5. 服务器端验证                      │
│ ├─ 验证API Key有效性                 │
│ ├─ 检查API Key配额                   │
│ ├─ 验证请求格式                      │
│ └─ 检查速率限制                      │
└──────┬───────────────────┬───────────┘
       │                   │
    成功│                   │失败
       │                   │
       ▼                   ▼
┌────────────────┐  ┌──────────────────────┐
│ 6. 处理请求    │  │ 返回错误响应         │
│ ├─ 路由到模型  │  │ ├─ 401: 认证失败    │
│ ├─ 执行推理    │  │ ├─ 429: 限流       │
│ └─ 生成响应    │  │ ├─ 400: 请求错误   │
└────────┬───────┘  │ └─ 500: 服务器错误 │
         │          └──────┬─────────────┘
         │                 │
         └────────┬────────┘
                  │
                  ▼
        ┌──────────────────────┐
        │ 7. 返回响应          │
        │ ├─ status_code       │
        │ ├─ choices[].message │
        │ ├─ usage统计         │
        │ └─ request_id        │
        └────────┬─────────────┘
                 │
                 ▼
        ┌──────────────────────┐
        │ 8. 处理响应          │
        │ ├─ 解析JSON          │
        │ ├─ 提取生成内容      │
        │ ├─ 统计token使用    │
        │ └─ 处理错误（如有）  │
        └────────┬─────────────┘
                 │
                 ▼
        ┌──────────────────────┐
        │ 9. 返回给用户        │
        └──────────────────────┘
```

---

## 2. 鉴权流程详解

```
┌─────────────────────────────────────────────────────────────────────┐
│                    QWen API 鉴权流程详解                             │
└─────────────────────────────────────────────────────────────────────┘

【第一步：API Key 获取与存储】

┌──────────────────────────────────────┐
│ 方式1：环境变量方式                   │
├──────────────────────────────────────┤
│ $ export DASHSCOPE_API_KEY=xxx        │
│                                       │
│ 优点：                                │
│ ✓ 代码中不涉及敏感信息               │
│ ✓ 安全性最高                         │
│ ✓ 易于团队协作                       │
│                                       │
│ 使用方式：                            │
│ import os                             │
│ api_key = os.getenv('DASHSCOPE_API_KEY')
└──────────────────────────────────────┘

┌──────────────────────────────────────┐
│ 方式2：.env文件方式                   │
├──────────────────────────────────────┤
│ # .env文件内容                        │
│ DASHSCOPE_API_KEY=your-api-key        │
│                                       │
│ 优点：                                │
│ ✓ 本地开发方便                       │
│ ✓ 避免硬编码                         │
│ ✓ 易于切换不同环境                   │
│                                       │
│ 使用方式：                            │
│ from dotenv import load_dotenv        │
│ load_dotenv()                         │
│ api_key = os.getenv('DASHSCOPE_API_KEY')
└──────────────────────────────────────┘

【第二步：客户端初始化】

┌──────────────────────────────────────────────────────────────┐
│ from openai import OpenAI                                     │
│                                                               │
│ client = OpenAI(                                              │
│     api_key="your-api-key",                                  │
│     base_url="https://dashscope.aliyun.com/compatible-mode/v1"
│ )                                                             │
│                                                               │
│ 说明：                                                        │
│ ├─ api_key: API密钥                                          │
│ ├─ base_url: API端点                                         │
│ │  ├─ 兼容模式：https://dashscope.aliyun.com/compatible-mode/v1
│ │  └─ 原生模式：https://dashscope.aliyun.com/api/v1        │
│ └─ 其他配置：                                                │
│    ├─ timeout: 请求超时时间                                │
│    ├─ max_retries: 最大重试次数                             │
│    └─ organization: 组织ID                                  │
└──────────────────────────────────────────────────────────────┘

【第三步：构建请求】

┌──────────────────────────────────────────────────────────────┐
│ response = client.chat.completions.create(                   │
│     model="qwen-plus",            # 模型选择                │
│     messages=[                    # 对话内容                │
│         {                                                    │
│             "role": "user",                                 │
│             "content": "你好"                              │
│         }                                                    │
│     ],                                                       │
│     temperature=0.7,              # 随机性                  │
│     max_tokens=1024               # 最大输出长度            │
│ )                                                            │
│                                                              │
│ 请求包装步骤：                                              │
│ 1. SDK将参数转换为JSON格式                                 │
│ 2. 添加Authorization头                                     │
│    Authorization: Bearer YOUR_API_KEY                        │
│ 3. 设置Content-Type: application/json                       │
│ 4. 发送POST请求到指定endpoint                              │
└──────────────────────────────────────────────────────────────┘

【第四步：服务器端验证】

              ┌─────────────────────────────────┐
              │  收到请求                       │
              └──────────┬──────────────────────┘
                         │
                    ┌────▼─────┐
                    │ 验证流程  │
                    └────┬─────┘
                         │
         ┌───────────────┼───────────────┐
         │               │               │
         ▼               ▼               ▼
    ┌─────────┐   ┌─────────┐   ┌─────────────┐
    │验证格式 │   │检查认证 │   │检查配额     │
    │         │   │         │   │             │
    │JSON有效?│   │Key存在?│   │配额充足?   │
    └────┬────┘   └────┬────┘   └─────┬───────┘
         │             │              │
         └─────┬───────┴──────┬───────┘
               │              │
            YES│              │NO
               │              │
         ┌─────▼────┐    ┌────▼─────────────┐
         │继续验证  │    │返回401/429错误  │
         └─────┬────┘    └──────┬──────────┘
               │                │
         ┌─────▼──────────┐     │
         │检查速率限制    │     │
         │请求频率过高? │     │
         └─────┬──────────┘     │
               │                │
            NO│                 │
         ┌─────▼────┐           │
         │验证通过  │           │
         └─────┬────┘           │
               │                │
               └────────┬───────┘
                        │
                        ▼
                  ┌─────────────┐
                  │返回响应     │
                  └─────────────┘
```

---

## 3. API Key 鉴权机制详解

```
┌──────────────────────────────────────────────────────────────┐
│         HTTP 请求中的鉴权头信息                              │
└──────────────────────────────────────────────────────────────┘

【请求包结构】

POST /v1/chat/completions HTTP/1.1
Host: dashscope.aliyun.com
Authorization: Bearer sk-xxxxxxxxxxxxxxxxxxxxx    ← 鉴权信息
Content-Type: application/json
User-Agent: OpenAI/Python 1.0.0
Accept-Encoding: gzip, deflate
Content-Length: 245

{
  "model": "qwen-plus",
  "messages": [
    {
      "role": "user",
      "content": "你好"
    }
  ],
  "temperature": 0.7,
  "max_tokens": 1024
}

【鉴权头说明】

Authorization: Bearer YOUR_API_KEY
│             │     │
│             │     └─ API Key值（sk-开头）
│             └─ 认证类型（Bearer token）
└─ HTTP标准鉴权头字段


【服务器验证流程】

1. 解析Authorization头
   ├─ 提取token类型（Bearer）
   └─ 提取API Key值

2. 在数据库中查询API Key
   ├─ Key是否存在？
   ├─ Key是否过期？
   └─ Key是否被禁用？

3. 关联账户和配额
   ├─ 获取账户信息
   ├─ 获取当前配额使用情况
   └─ 检查是否超出限额

4. 检查速率限制
   ├─ 请求频率是否过高？
   ├─ 并发数是否超限？
   └─ 每日请求数是否超限？

5. 验证结果
   ├─ 所有检查通过 → 允许请求
   └─ 任何检查失败 → 返回错误响应
```

---

## 4. 两种调用方式的鉴权对比

```
┌──────────────────────────────────────────────────────────────┐
│     OpenAI兼容接口 vs DashScope原生接口                       │
└──────────────────────────────────────────────────────────────┘

【OpenAI兼容接口】

Base URL: https://dashscope.aliyun.com/compatible-mode/v1

代码示例：
┌─────────────────────────────────────────────────────────────┐
│ from openai import OpenAI                                   │
│                                                             │
│ client = OpenAI(                                            │
│     api_key="YOUR_API_KEY",                                │
│     base_url="https://dashscope.aliyun.com/compatible-mode/v1"
│ )                                                           │
│                                                             │
│ response = client.chat.completions.create(                │
│     model="qwen-plus",                                     │
│     messages=[                                             │
│         {"role": "user", "content": "你好"}               │
│     ]                                                      │
│ )                                                          │
│                                                            │
│ print(response.choices[0].message.content)                │
└─────────────────────────────────────────────────────────────┘

优点：
✓ 与OpenAI API完全兼容
✓ 可直接使用OpenAI SDK
✓ 学习成本低
✓ 迁移成本低（如果需要切换到OpenAI）
✓ 生态丰富（基于OpenAI的工具都可用）

缺点：
✗ 部分QWen特性可能受限


【DashScope原生接口】

Base URL: https://dashscope.aliyun.com/api/v1

代码示例：
┌─────────────────────────────────────────────────────────────┐
│ from dashscope import Generation                            │
│ import dashscope                                            │
│                                                             │
│ dashscope.api_key = 'YOUR_API_KEY'                         │
│                                                             │
│ response = Generation.call(                                │
│     model='qwen-plus',                                     │
│     messages=[                                             │
│         {'role': 'user', 'content': '你好'}               │
│     ]                                                      │
│ )                                                          │
│                                                            │
│ if response.status_code == 200:                            │
│     print(response.output.choices[0].message.content)      │
│ else:                                                      │
│     print(f"Error: {response.code}")                       │
└─────────────────────────────────────────────────────────────┘

优点：
✓ 支持更多QWen特性
✓ 更详细的错误信息
✓ 更灵活的配置
✓ 原生支持QWen特有功能

缺点：
✗ 需要使用DashScope SDK
✗ 与OpenAI API不兼容
✗ 代码迁移成本高


【两种接口的鉴权对比】

                 OpenAI兼容        DashScope原生
─────────────────────────────────────────────────
鉴权方式          Authorization: Bearer     设置api_key变量
                  HTTP头                    
─────────────────────────────────────────────────
Base URL          compatible-mode/v1        api/v1
─────────────────────────────────────────────────
SDK               openai                    dashscope
─────────────────────────────────────────────────
响应格式          JSON (OpenAI标准)        JSON (DashScope标准)
─────────────────────────────────────────────────
错误代码          HTTP状态码               code字段
─────────────────────────────────────────────────
特性支持          基础特性                  全部特性
─────────────────────────────────────────────────
推荐场景          快速开发、原型            生产环境、复杂功能
─────────────────────────────────────────────────
```

---

## 5. 错误处理与重试流程

```
┌──────────────────────────────────────────────────────────────┐
│           错误处理与重试机制流程图                            │
└──────────────────────────────────────────────────────────────┘

                    ┌─────────────┐
                    │发送请求     │
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │等待响应     │
                    └──────┬──────┘
                           │
                ┌──────────┴──────────┐
                │                     │
            成功│                  失败│
                │                     │
         ┌──────▼─────┐      ┌───────▼────────┐
         │解析响应    │      │检查错误类型   │
         │（200 OK）  │      └───────┬────────┘
         └──────┬─────┘              │
                │         ┌──────────┼──────────┐
                │         │          │          │
                │   ┌─────▼──┐ ┌────▼──┐ ┌───▼────┐
                │   │401认证 │ │429限流│ │500服务│
                │   │失败    │ │错误   │ │器错误 │
                │   └─────┬──┘ └────┬──┘ └───┬────┘
                │         │        │         │
                │         │     ┌──▼──┐   ┌─▼──────┐
                │         │     │重试?│   │重试?   │
                │         │     └──┬──┘   └─┬──────┘
                │         │        │        │
                │    ┌────┼────┐   │    ┌───┼────┐
                │    │    │    │   │    │   │    │
                │  NO│  YES  YES  │  YES  │
                │    │    │    │   │    │   │    │
       ┌────────▼────┼─┐  │ ┌─┴───▼───┐ │ ┌┴──────▼──┐
       │返回错误     │ │  │ │等待后  │ │ │等待1-3秒 │
       │给用户       │ │  │ │重试    │ │ │指数退避  │
       └────────┬────┘ │  │ └─┬───┬─┘ │ │ └┬────────┘
                │      │  │   │   │   │ │  │
                │      └──┼──┤   │   │ │  │
                │         │  │   │   │ │  │
       ┌────────▼─────┐   │  │ ┌─▼───▼─▼──┴──┐
       │结束          │   │  │ │重试次数    │
       └──────────────┘   │  │ │达到限制?   │
                          │  │ └─┬─────┬────┘
                          │  │   │     │
                          │  │  YES  NO
                          │  │   │     │
                          │  │ ┌─▼──┐ │
                          │  │ │返回 │ │
                          │  │ │错误 │ │
                          │  │ └────┘ │
                          │  │        │
                          │  └────┬───┘
                          │       │
                          └───┬───┘
                              │
                        ┌─────▼─────┐
                        │重新发送   │
                        │请求      │
                        └─────┬─────┘
                              │
                              └──────┐
                                     │
                   (返回开始重新发送)
```

---

## 6. 完整的 Python 调用流程示例

```python
【完整调用流程代码】

# ============================================================================
# 第一步：初始化和鉴权
# ============================================================================

import os
from openai import OpenAI, RateLimitError, APIConnectionError

# 方式1: 从环境变量获取API Key
api_key = os.getenv('DASHSCOPE_API_KEY')

# 方式2: 从.env文件获取
from dotenv import load_dotenv
load_dotenv()
api_key = os.getenv('DASHSCOPE_API_KEY')

# 初始化客户端
# 此时会自动设置Authorization头为: Bearer {api_key}
client = OpenAI(
    api_key=api_key,
    base_url="https://dashscope.aliyun.com/compatible-mode/v1",
    timeout=30  # 超时设置
)

# ============================================================================
# 第二步：构建请求
# ============================================================================

# 准备消息
messages = [
    {
        "role": "user",
        "content": "请解释什么是机器学习？"
    }
]

# ============================================================================
# 第三步：发送请求（包含鉴权）
# ============================================================================

try:
    # 发送请求，自动包含API Key鉴权信息
    response = client.chat.completions.create(
        model="qwen-plus",           # 选择模型
        messages=messages,            # 发送消息
        temperature=0.7,              # 随机性参数
        max_tokens=1024,              # 最大输出长度
        stream=False                  # 是否使用流式输出
    )
    
    # ========================================================================
    # 第四步：处理响应
    # ========================================================================
    
    # 解析响应
    generated_text = response.choices[0].message.content
    
    # 获取token统计
    input_tokens = response.usage.input_tokens
    output_tokens = response.usage.output_tokens
    total_tokens = response.usage.total_tokens
    
    print(f"生成内容: {generated_text}")
    print(f"Token使用: 输入{input_tokens}, 输出{output_tokens}, 总计{total_tokens}")
    
# ============================================================================
# 第五步：错误处理与重试
# ============================================================================
    
except RateLimitError as e:
    # 状态码: 429 - 触发限流
    print("API限流，请稍后再试")
    print(f"错误信息: {str(e)}")
    # 应该实施指数退避重试
    
except APIConnectionError as e:
    # 网络连接错误
    print("网络连接错误")
    print(f"错误信息: {str(e)}")
    # 应该重试连接
    
except Exception as e:
    # 其他错误（如认证失败、请求格式错误等）
    print(f"发生错误: {type(e).__name__}")
    print(f"错误信息: {str(e)}")

# ============================================================================
# 【流程小结】
# ============================================================================
# 
# 1. 初始化 → API Key 被设置到客户端
# 2. 构建请求 → 消息被格式化为JSON
# 3. 发送请求 → SDK自动添加Authorization头
# 4. 服务器验证 → 检查API Key有效性和配额
# 5. 处理请求 → 模型推理生成响应
# 6. 返回响应 → JSON格式的回复
# 7. 解析响应 → 提取生成内容和token统计
# 8. 错误处理 → 根据状态码采取相应行动
```

---

## 7. 流式调用的鉴权流程

```
┌──────────────────────────────────────────────────────────────┐
│         流式调用（Streaming）的鉴权与响应流程                 │
└──────────────────────────────────────────────────────────────┘

【传统调用 vs 流式调用】

传统调用：
  客户端          服务器
    │              │
    │─ 发送请求 ──►│
    │              │ 处理请求
    │              │ 生成完整响应
    │◄── 返回全部响应 ──│
    │              │
    │ 解析响应     │
    │              │

流式调用：
  客户端          服务器
    │              │
    │─ 发送请求 ──►│
    │ (含Authorization头)│
    │              │ 验证鉴权
    │◄──数据块1──│ (认证通过)
    │◄──数据块2──│ 
    │◄──数据块3──│ 持续发送数据块
    │◄──...────│
    │◄──[DONE]──│ 完成标记
    │              │
    │ 实时处理    │
    │              │


【流式响应数据格式】

HTTP/1.1 200 OK
Content-Type: text/event-stream
Transfer-Encoding: chunked
Authorization: Bearer validated ← 鉴权成功
X-Request-Id: uuid-1234-5678

data: {"output":{"choices":[{"finish_reason":"null","message":{"role":"assistant","content":"我"}}]},"usage":{"input_tokens":10,"output_tokens":1}}

data: {"output":{"choices":[{"finish_reason":"null","message":{"role":"assistant","content":"是"}}]},"usage":{"input_tokens":10,"output_tokens":2}}

data: {"output":{"choices":[{"finish_reason":"null","message":{"role":"assistant","content":"一"}}]},"usage":{"input_tokens":10,"output_tokens":3}}

...更多数据块...

data: [DONE]


【Python流式调用代码】

response = client.chat.completions.create(
    model="qwen-plus",
    messages=[{"role": "user", "content": "请写一首诗"}],
    stream=True  # 启用流式响应
)

# 遍历响应流
for chunk in response:
    if chunk.choices[0].delta.content:
        # 实时处理每个文本块
        print(chunk.choices[0].delta.content, end='', flush=True)


【流程说明】

1. 发送请求时
   ├─ Authorization头仍然被发送
   ├─ 服务器进行鉴权验证
   └─ 鉴权通过后开始流式传输

2. 流式传输过程
   ├─ 每个数据块都包含部分回复
   ├─ 客户端实时接收和处理
   ├─ 用户看到逐字出现的效果
   └─ 改善用户体验

3. 流式传输结束
   ├─ 服务器发送 [DONE] 标记
   ├─ 客户端停止接收
   └─ 流式完成
```

---

## 8. 多种错误状态码与处理方案

```
┌──────────────────────────────────────────────────────────────┐
│          常见HTTP状态码与处理方案                             │
└──────────────────────────────────────────────────────────────┘

┌─────────┬─────────────────────────────────────────────────────┐
│状态码   │ 含义与处理方案                                       │
├─────────┼─────────────────────────────────────────────────────┤
│         │                                                     │
│ 200 OK  │ ✅ 请求成功                                         │
│         │ └─ 正常处理响应数据                                │
│         │                                                     │
├─────────┼─────────────────────────────────────────────────────┤
│         │                                                     │
│ 400     │ ❌ 请求格式错误                                     │
│ Bad     │ └─ 原因：                                          │
│ Request │   ├─ JSON格式不正确                               │
│         │   ├─ 缺少必需字段                                 │
│         │   ├─ 参数类型错误                                 │
│         │   └─ 模型名称不存在                               │
│         │ └─ 处理方案：                                      │
│         │   ├─ 检查请求格式                                 │
│         │   ├─ 验证所有参数                                 │
│         │   └─ 不需要重试（需要修改代码）                  │
│         │                                                     │
├─────────┼─────────────────────────────────────────────────────┤
│         │                                                     │
│ 401     │ ❌ 认证失败（无效的API Key）                        │
│ Unauth  │ └─ 原因：                                          │
│ orized  │   ├─ API Key过期                                  │
│         │   ├─ API Key被删除                               │
│         │   ├─ API Key格式错误                             │
│         │   └─ API Key权限不足                             │
│         │ └─ 处理方案：                                      │
│         │   ├─ 检查API Key是否正确                         │
│         │   ├─ 访问dashscope.aliyun.com检查Key状态       │
│         │   ├─ 更新API Key                                │
│         │   └─ 不需要重试（需要修复鉴权）                 │
│         │                                                     │
├─────────┼─────────────────────────────────────────────────────┤
│         │                                                     │
│ 403     │ ❌ 禁止访问（账户被禁用）                           │
│ Forbidden│ └─ 原因：                                         │
│         │   ├─ 账户欠费                                     │
│         │   ├─ 账户被冻结                                   │
│         │   ├─ 违反使用政策                                 │
│         │   └─ 配额已用尽                                   │
│         │ └─ 处理方案：                                      │
│         │   ├─ 联系阿里云支持                              │
│         │   ├─ 检查账户状态                                │
│         │   └─ 不需要重试（需要处理账户问题）              │
│         │                                                     │
├─────────┼─────────────────────────────────────────────────────┤
│         │                                                     │
│ 429     │ ⚠️  限流（请求过于频繁）                           │
│ Too Many│ └─ 原因：                                          │
│ Requests│   ├─ 请求频率超过限制                            │
│         │   ├─ 并发数超过限制                              │
│         │   ├─ 配额已用尽                                  │
│         │   └─ 账户受限                                    │
│         │ └─ 处理方案：                                      │
│         │   ├─ ✅ 立即重试（使用指数退避）                 │
│         │   ├─ 添加等待时间                                │
│         │   ├─ 减少并发数                                  │
│         │   └─ 升级账户配额                                │
│         │                                                     │
├─────────┼─────────────────────────────────────────────────────┤
│         │                                                     │
│ 500     │ ❌ 服务器错误                                       │
│ Internal│ └─ 原因：                                          │
│ Server  │   ├─ 服务器故障                                   │
│ Error   │   ├─ 数据库错误                                   │
│         │   └─ 模型推理错误                                │
│         │ └─ 处理方案：                                      │
│         │   ├─ ✅ 重试（使用指数退避）                     │
│         │   ├─ 等待后重新发送                              │
│         │   └─ 持续失败则报告issue                         │
│         │                                                     │
├─────────┼─────────────────────────────────────────────────────┤
│         │                                                     │
│ 503     │ ❌ 服务不可用（维护中）                             │
│ Service │ └─ 原因：                                          │
│ Unavail │   ├─ 服务器维护                                   │
│ able    │   ├─ 过载保护                                     │
│         │   └─ 临时故障                                    │
│         │ └─ 处理方案：                                      │
│         │   ├─ ✅ 重试（使用指数退避）                     │
│         │   ├─ 等待较长时间后重试                         │
│         │   └─ 查看status.aliyun.com了解服务状态         │
│         │                                                     │
└─────────┴─────────────────────────────────────────────────────┘


【重试策略】

建议重试：      ┌────────────────────────────┐
               │ 状态码: 429, 500, 503       │
               │ 策略: 指数退避 + 随机抖动   │
               │                            │
               │ 等待时间计算：             │
               │ delay = (2^attempt) + random
               │                            │
               │ 第1次重试: ~1秒            │
               │ 第2次重试: ~3秒            │
               │ 第3次重试: ~7秒            │
               │ 第4次重试: ~15秒           │
               │ 第5次重试: ~30秒           │
               │                            │
               │ 最大重试: 3-5次            │
               └────────────────────────────┘

不建议重试：    ┌────────────────────────────┐
               │ 状态码: 400, 401, 403       │
               │                            │
               │ 这些是客户端错误，重试也   │
               │ 会失败。应该修复代码或     │
               │ 处理账户问题。             │
               └────────────────────────────┘
```

---

## 9. 快速参考表

```
┌───────────────────────────────────────────────────────────────┐
│                    快速参考表                                  │
└───────────────────────────────────────────────────────────────┘

【API端点】
OpenAI兼容: https://dashscope.aliyun.com/compatible-mode/v1
DashScope原生: https://dashscope.aliyun.com/api/v1

【鉴权方式】
OpenAI SDK: Authorization: Bearer YOUR_API_KEY (自动处理)
DashScope SDK: 设置 dashscope.api_key = 'YOUR_API_KEY'

【获取API Key】
1. 访问 https://dashscope.aliyun.com/
2. 登录阿里云账户
3. 创建API Key
4. 存储到环境变量或.env文件

【模型选择】
qwen-turbo: ¥0.0003/1K (输入) - 快速、经济
qwen-plus: ¥0.0008/1K (输入) - 推荐、平衡
qwen-max: ¥0.02/1K (输入) - 强大、贵

【常见错误处理】
401: 重新检查API Key
429: 使用指数退避重试
500: 等待后重试
400: 检查请求格式

【流式调用】
stream=True 启用流式输出
stream=False 等待完整响应

【配置参数】
temperature: 0-2 (随机性)
top_p: 0-1 (核采样)
max_tokens: 最大输出长度
```

---

## 总结

这个完整的流程图涵盖了：

✅ **完整的端到端调用流程** - 从初始化到响应处理  
✅ **详细的鉴权机制** - API Key获取、验证、授权  
✅ **两种调用方式对比** - OpenAI兼容 vs DashScope原生  
✅ **错误处理与重试** - 各类错误的处理方案  
✅ **流式调用流程** - 实时数据传输  
✅ **HTTP请求细节** - 鉴权头、请求体、响应体  
✅ **所有错误状态码** - 8种常见状态码与处理方案  

这些流程图可以帮助你快速理解QWen API的鉴权和调用过程！
